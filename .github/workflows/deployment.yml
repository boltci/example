name: Deployment

on:
  workflow_run:
    workflows: [ Prerequisite ]
    types: [ completed ]

  check_run:
    types: [ completed ]

concurrency:
  group: deployment-${{ github.event.workflow_run.head_sha || github.event.check_run.head_sha }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Trigger Deployment
    if: |
      github.ref == 'refs/heads/main' &&
      (
        (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
        (github.event_name == 'check_run' && github.event.check_run.conclusion == 'success' && github.event.check_run.name == 'Backend Tests')
      )
    runs-on: ubuntu-latest

    steps:
      - name: Determine if all required checks have passed
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.eventName === 'workflow_run'
              ? context.payload.workflow_run.head_sha
              : context.payload.check_run.head_sha;

            console.log(`Checking status for commit: ${sha}`);

            const { data } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha,
            });

            const prerequisitePassed = data.check_runs.some(
              check => check.name === 'Prerequisite / prerequisite-job (push)' && check.conclusion === 'success'
            );
            const backendTestsPassed = data.check_runs.some(
              check => check.name === 'Backend Tests' && check.conclusion === 'success'
            );

            console.log(`Prerequisite: ${prerequisitePassed ? 'PASSED' : 'NOT PASSED'}`);
            console.log(`Backend Tests: ${backendTestsPassed ? 'PASSED' : 'NOT PASSED'}`);

            return prerequisitePassed && backendTestsPassed;

      - name: Trigger deployment
        if: steps.check.outputs.result == 'true'
        run: echo "Pretending to trigger deployment..."
