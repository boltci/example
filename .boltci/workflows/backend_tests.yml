name: Backend Tests

on: push

use: ubuntu:24.04

setup:
  php:
    version: "8.3"
  mysql:
    version: "8.0"
    username: "root"
    password: ""
    databases:
      - laravel

configure:
  max_processes_per_runner: 8

preheat:
  extend: run
  run_tests:
      run: SHARD=1/50 php artisan test --parallel --functional --processes=$BOLTCI_PROCESSES

run:
  install_dependencies:
    watch: composer.lock,composer.json
    run: composer install --no-progress --optimize-autoloader --apcu-autoloader
      && php artisan shards:patch-phpunit
      && php artisan shards:patch-paratest

  setup_environment:
    watch: .env.example
    run: cp .env.example .env
      && php artisan key:generate

  run_migrations:
    watch: database/migrations/*.php
    run: php artisan migrate --force

  cache_routes:
    watch: routes/*.php
    run: php artisan route:cache

  run_tests:
    run: SHARD=$BOLTCI_SHARD php artisan test --parallel --functional --processes=$BOLTCI_PROCESSES


